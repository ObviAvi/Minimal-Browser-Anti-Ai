<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-AI Browser</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="browser-container">
        <!-- Custom Title Bar -->
        <div class="title-bar">
            <div class="title-bar-drag"></div>
            <div class="window-controls">
                <button class="window-btn minimize" id="minimize-btn">‚îÄ</button>
                <button class="window-btn maximize" id="maximize-btn">‚ñ°</button>
                <button class="window-btn close" id="close-btn">√ó</button>
            </div>
        </div>

        <!-- Tab Bar (Chrome-style above URL bar) -->
        <div class="tab-bar">
            <div class="tabs-container" id="tabs-container">
                <!-- Tabs will be dynamically added here -->
            </div>
            <button class="new-tab-btn" id="new-tab-btn" title="New Tab (Ctrl+T)">+</button>
        </div>

        <header class="ui-header">
            <div class="nav-controls">
                <button class="nav-btn" id="back-btn" title="Go Back"><span>‚Üê</span></button>
                <button class="nav-btn" id="forward-btn" title="Go Forward"><span>‚Üí</span></button>
                <button class="nav-btn" id="refresh-btn" title="Refresh"><span>‚Üª</span></button>
                <button class="nav-btn" id="home-btn" title="Home"><span>‚åÇ</span></button>
            </div>

            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input type="text" id="url-input" placeholder="Enter URL or Search... & No AI">
                <div class="loading-spinner" id="loading-spinner"></div>
            </div>

            <button class="nav-btn bookmark-btn" id="bookmark-btn" title="Bookmark this page">
                <span id="bookmark-icon">‚òÜ</span>
            </button>

            <div class="status-badge" title="Blocked requests">
                <span class="dot"></span>
                <span id="blocked-count">0</span>&nbsp;BLOCKED
            </div>

            <button class="nav-btn" id="history-btn" title="History">
                <span>üìú</span>
            </button>

            <button class="nav-btn" id="bookmarks-panel-btn" title="Bookmarks">
                <span>üìö</span>
            </button>

            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                <span class="theme-icon">üåô</span>
            </button>
        </header>

        <!-- Bookmarks Dropdown -->
        <div class="dropdown-panel" id="bookmarks-panel">
            <div class="panel-header">
                <h3>Bookmarks</h3>
                <button class="panel-close" id="close-bookmarks">√ó</button>
            </div>
            <div class="panel-content" id="bookmarks-list">
                <!-- Bookmarks will be dynamically added -->
            </div>
        </div>

        <!-- History Dropdown -->
        <div class="dropdown-panel" id="history-panel">
            <div class="panel-header">
                <h3>History</h3>
                <button class="clear-btn" id="clear-history">Clear All</button>
                <button class="panel-close" id="close-history">√ó</button>
            </div>
            <div class="panel-content" id="history-list">
                <!-- History will be dynamically added -->
            </div>
        </div>

        <main class="content-area">
            <div class="card-grid" id="home-view">
                <div class="card" data-url="https://wikipedia.org">
                    <div class="card-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    </div>
                    <div class="card-content">
                        <h3>Wikipedia</h3>
                        <p>The Free Encyclopedia</p>
                    </div>
                </div>
                <div class="card" data-url="https://github.com">
                    <div class="card-image" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    </div>
                    <div class="card-content">
                        <h3>GitHub</h3>
                        <p>Where Code Lives</p>
                    </div>
                </div>
                <div class="card" data-url="https://stackoverflow.com">
                    <div class="card-image" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    </div>
                    <div class="card-content">
                        <h3>Stack Overflow</h3>
                        <p>Developer Community</p>
                    </div>
                </div>
                <div class="card" data-url="https://developer.mozilla.org">
                    <div class="card-image" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    </div>
                    <div class="card-content">
                        <h3>MDN Web Docs</h3>
                        <p>Web Development Resources</p>
                    </div>
                </div>
                <div class="card" data-url="https://duckduckgo.com">
                    <div class="card-image" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    </div>
                    <div class="card-content">
                        <h3>DuckDuckGo</h3>
                        <p>Privacy-Focused Search</p>
                    </div>
                </div>
                <div class="card" data-url="https://news.ycombinator.com">
                    <div class="card-image" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    </div>
                    <div class="card-content">
                        <h3>Hacker News</h3>
                        <p>Tech News & Discussion</p>
                    </div>
                </div>
                <div class="card" data-url="https://youtube.com">
                    <div class="card-image" style="background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);">
                    </div>
                    <div class="card-content">
                        <h3>YouTube</h3>
                        <p>Video Platform</p>
                    </div>
                </div>
                <div class="card" data-url="https://reddit.com">
                    <div class="card-image" style="background: linear-gradient(135deg, #ff4500 0%, #ff8717 100%);">
                    </div>
                    <div class="card-content">
                        <h3>Reddit</h3>
                        <p>Community Forums</p>
                    </div>
                </div>
            </div>

            <div class="webviews-container" id="webviews-container">
                <!-- Webviews will be dynamically added here -->
            </div>
        </main>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        // DOM Elements
        const tabsContainer = document.getElementById('tabs-container');
        const webviewsContainer = document.getElementById('webviews-container');
        const newTabBtn = document.getElementById('new-tab-btn');
        const input = document.getElementById('url-input');
        const homeView = document.getElementById('home-view');
        const backBtn = document.getElementById('back-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const homeBtn = document.getElementById('home-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const bookmarkIcon = document.getElementById('bookmark-icon');
        const historyBtn = document.getElementById('history-btn');
        const bookmarksPanelBtn = document.getElementById('bookmarks-panel-btn');
        const bookmarksPanel = document.getElementById('bookmarks-panel');
        const historyPanel = document.getElementById('history-panel');
        const bookmarksList = document.getElementById('bookmarks-list');
        const historyList = document.getElementById('history-list');
        const blockedCountEl = document.getElementById('blocked-count');

        // State
        let tabs = [];
        let activeTabId = null;
        let tabCounter = 0;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
        let history = JSON.parse(localStorage.getItem('history') || '[]');
        let blockedCount = 0;

        // Window Controls
        document.getElementById('minimize-btn').addEventListener('click', () => ipcRenderer.send('window-minimize'));
        document.getElementById('maximize-btn').addEventListener('click', () => ipcRenderer.send('window-maximize'));
        document.getElementById('close-btn').addEventListener('click', () => ipcRenderer.send('window-close'));

        // Receive blocked counts from main process
        ipcRenderer.on('blocked-counts', (event, counts) => {
            blockedCount = counts.ads + counts.ai;
            blockedCountEl.textContent = blockedCount;
        });

        // Request initial blocked counts
        ipcRenderer.send('get-blocked-counts');

        // Tab Management
        function createTab(url = null) {
            const tabId = `tab-${++tabCounter}`;

            // Create tab element
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.tabId = tabId;
            tab.innerHTML = `
                <img class="tab-favicon" src="" alt="">
                <span class="tab-title">New Tab</span>
                <button class="tab-close" title="Close Tab">√ó</button>
            `;
            tabsContainer.appendChild(tab);

            // Create webview
            const webview = document.createElement('webview');
            webview.id = tabId;
            webview.className = 'webview-content';
            webview.setAttribute('partition', 'persist:main');
            // Use latest Chrome User-Agent to pass Google's browser checks
            webview.setAttribute('useragent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36');
            // Enable features needed for modern web authentication (OAuth, third-party cookies, popups)
            webview.setAttribute('webpreferences', 'allowRunningInsecureContent=no, javascript=yes, webSecurity=yes, contextIsolation=no, allowPopups=yes, nativeWindowOpen=yes');
            webview.setAttribute('allowpopups', '');  // Allow OAuth popups
            webview.src = url || 'about:blank';
            webview.style.display = 'none';
            webviewsContainer.appendChild(webview);

            // Store tab data
            const tabData = {
                id: tabId,
                tabElement: tab,
                webview: webview,
                title: 'New Tab',
                url: url || '',
                isHome: !url,
                isLoading: false,
                isSearchResults: false,
                searchQuery: '',
                lastSearchResults: null
            };
            tabs.push(tabData);

            // Tab click handler
            tab.addEventListener('click', (e) => {
                if (!e.target.classList.contains('tab-close')) {
                    switchToTab(tabId);
                }
            });

            // Tab close handler
            tab.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });

            // Webview event handlers
            setupWebviewEvents(tabData);

            // Switch to new tab
            switchToTab(tabId);

            return tabData;
        }

        function setupWebviewEvents(tabData) {
            const { webview, tabElement } = tabData;

            webview.addEventListener('did-start-loading', () => {
                tabData.isLoading = true;
                if (tabData.id === activeTabId) {
                    loadingSpinner.classList.add('active');
                }
            });

            webview.addEventListener('did-stop-loading', () => {
                tabData.isLoading = false;
                if (tabData.id === activeTabId) {
                    loadingSpinner.classList.remove('active');
                }
            });

            webview.addEventListener('did-navigate', (e) => {
                if (e.url === 'about:blank') return;

                if (e.url.startsWith('data:')) {
                    tabData.isSearchResults = true;
                    if (tabData.id === activeTabId) {
                        input.value = tabData.searchQuery;
                    }
                } else {
                    tabData.url = e.url;
                    tabData.isSearchResults = false;
                    tabData.isHome = false;
                    if (tabData.id === activeTabId) {
                        input.value = e.url;
                        updateBookmarkIcon();
                    }
                    addToHistory(e.url, tabData.title);
                }
            });

            webview.addEventListener('did-navigate-in-page', (e) => {
                if (!e.url.startsWith('data:') && e.url !== 'about:blank') {
                    tabData.url = e.url;
                    tabData.isSearchResults = false;
                    if (tabData.id === activeTabId) {
                        input.value = e.url;
                        updateBookmarkIcon();
                    }
                }
            });

            webview.addEventListener('page-title-updated', (e) => {
                tabData.title = e.title;
                tabElement.querySelector('.tab-title').textContent = e.title.substring(0, 20) + (e.title.length > 20 ? '...' : '');
            });

            webview.addEventListener('page-favicon-updated', (e) => {
                if (e.favicons && e.favicons.length > 0) {
                    tabElement.querySelector('.tab-favicon').src = e.favicons[0];
                }
            });

            webview.addEventListener('will-navigate', (e) => {
                if (tabData.isSearchResults && !e.url.startsWith('data:')) {
                    e.preventDefault();
                    webview.src = e.url;
                    tabData.isSearchResults = false;
                }
            });

            webview.addEventListener('did-fail-load', (e) => {
                if (e.errorCode !== -3) { // Ignore aborted loads
                    console.error('Page load failed:', e.errorDescription);
                }
            });

            // Handle new windows (OAuth popups, login dialogs, etc.)
            webview.addEventListener('new-window', (e) => {
                const url = e.url;
                // For OAuth/login popups, open in the same tab instead of blocking
                // Real browsers would open a popup, but we'll navigate in the same tab for simplicity
                if (e.disposition === 'foreground-tab' || e.disposition === 'new-window') {
                    webview.src = url;
                } else {
                    // For background tabs, create a new tab
                    createTab(url);
                }
            });
        }

        function switchToTab(tabId) {
            const prevTab = tabs.find(t => t.id === activeTabId);
            const newTab = tabs.find(t => t.id === tabId);

            if (!newTab) return;

            // Update previous tab
            if (prevTab) {
                prevTab.tabElement.classList.remove('active');
                prevTab.webview.style.display = 'none';
            }

            // Activate new tab
            activeTabId = tabId;
            newTab.tabElement.classList.add('active');

            if (newTab.isHome) {
                homeView.style.display = 'grid';
                newTab.webview.style.display = 'none';
                input.value = '';
            } else {
                homeView.style.display = 'none';
                newTab.webview.style.display = 'flex';
                input.value = newTab.isSearchResults ? newTab.searchQuery : newTab.url;
            }

            // Update loading state
            if (newTab.isLoading) {
                loadingSpinner.classList.add('active');
            } else {
                loadingSpinner.classList.remove('active');
            }

            updateBookmarkIcon();
        }

        function closeTab(tabId) {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            const tab = tabs[tabIndex];
            tab.tabElement.remove();
            tab.webview.remove();
            tabs.splice(tabIndex, 1);

            // If closing active tab, switch to another
            if (tabId === activeTabId) {
                if (tabs.length > 0) {
                    const newActiveIndex = Math.min(tabIndex, tabs.length - 1);
                    switchToTab(tabs[newActiveIndex].id);
                } else {
                    // No tabs left, create a new one
                    createTab();
                }
            }
        }

        function getActiveTab() {
            return tabs.find(t => t.id === activeTabId);
        }

        // Navigation functions
        function navigateToUrl(url) {
            const tab = getActiveTab();
            if (!tab) return;

            tab.isHome = false;
            tab.isSearchResults = false;
            homeView.style.display = 'none';
            tab.webview.style.display = 'flex';
            tab.webview.src = url;
        }

        function showHomeForTab() {
            const tab = getActiveTab();
            if (!tab) return;

            tab.isHome = true;
            tab.isSearchResults = false;
            tab.searchQuery = '';
            tab.lastSearchResults = null;
            homeView.style.display = 'grid';
            tab.webview.style.display = 'none';
            input.value = '';
            tab.tabElement.querySelector('.tab-title').textContent = 'New Tab';
            tab.tabElement.querySelector('.tab-favicon').src = '';
        }

        function isURL(text) {
            if (/\s/.test(text)) return false;
            if (text.startsWith('http://') || text.startsWith('https://')) return true;
            if (/\.\w{2,}/.test(text)) return true;
            if (text.startsWith('localhost') || /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(text)) return true;
            return false;
        }

        async function performSearch(query) {
            const tab = getActiveTab();
            if (!tab) return;

            tab.searchQuery = query;

            try {
                const response = await fetch(`https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`);
                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const results = [];
                const resultElements = doc.querySelectorAll('.result');

                resultElements.forEach(element => {
                    const titleLink = element.querySelector('.result__a');
                    const snippetEl = element.querySelector('.result__snippet');
                    const urlEl = element.querySelector('.result__url');

                    if (titleLink) {
                        let url = titleLink.href || '';
                        if (url.includes('uddg=')) {
                            const match = url.match(/uddg=([^&]+)/);
                            if (match) url = decodeURIComponent(match[1]);
                        }
                        if (!url && urlEl) {
                            url = urlEl.textContent.trim();
                        }

                        if (url) {
                            results.push({
                                title: titleLink.textContent.trim(),
                                url: url,
                                description: snippetEl ? snippetEl.textContent.trim() : ''
                            });
                        }
                    }
                });

                displaySearchResults(query, results);
            } catch (error) {
                console.error('Search error:', error);
                displaySearchResults(query, []);
            }
        }

        function displaySearchResults(query, results) {
            const tab = getActiveTab();
            if (!tab) return;

            tab.lastSearchResults = { query, results };
            tab.isSearchResults = true;

            const darkMode = document.body.classList.contains('dark-mode');

            let resultsHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        @keyframes fadeInUp {
                            from { opacity: 0; transform: translateY(20px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        body {
                            margin: 0;
                            padding: 40px;
                            background: ${darkMode ? '#1a1a2e' : '#f2eee6'};
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
                            transition: background 0.3s ease;
                        }
                        .search-header {
                            margin-bottom: 30px;
                            animation: fadeInUp 0.5s ease;
                        }
                        .search-header h2 {
                            color: ${darkMode ? '#e0e0e0' : '#333'};
                            margin: 0 0 10px 0;
                            font-size: 1.5rem;
                            font-weight: 600;
                        }
                        .result-count {
                            color: ${darkMode ? '#888' : '#888'};
                            font-size: 0.9rem;
                        }
                        .result {
                            background: ${darkMode ? '#252542' : 'white'};
                            padding: 20px 25px;
                            margin-bottom: 15px;
                            border-radius: 12px;
                            box-shadow: ${darkMode ? '0 4px 15px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.05)'};
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            cursor: pointer;
                            border: 2px solid transparent;
                            animation: fadeInUp 0.5s ease backwards;
                        }
                        .result:nth-child(1) { animation-delay: 0.1s; }
                        .result:nth-child(2) { animation-delay: 0.15s; }
                        .result:nth-child(3) { animation-delay: 0.2s; }
                        .result:nth-child(4) { animation-delay: 0.25s; }
                        .result:nth-child(5) { animation-delay: 0.3s; }
                        .result:hover {
                            box-shadow: ${darkMode ? '0 8px 25px rgba(143, 211, 206, 0.2)' : '0 8px 25px rgba(0,0,0,0.12)'};
                            transform: translateY(-4px) scale(1.01);
                            border-color: #8fd3ce;
                        }
                        .result-link {
                            text-decoration: none;
                            color: inherit;
                            display: block;
                        }
                        .result-title {
                            font-size: 1.2rem;
                            color: ${darkMode ? '#8fd3ce' : '#1a73e8'};
                            font-weight: 500;
                            margin-bottom: 8px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .result:hover .result-title {
                            color: ${darkMode ? '#a8e6cf' : '#1557b0'};
                        }
                        .result-favicon {
                            width: 20px;
                            height: 20px;
                            border-radius: 4px;
                            flex-shrink: 0;
                        }
                        .result-url {
                            color: ${darkMode ? '#6b6b8d' : '#5f6368'};
                            font-size: 0.85rem;
                            margin-bottom: 8px;
                            word-break: break-all;
                            padding-left: 30px;
                        }
                        .result-description {
                            color: ${darkMode ? '#b0b0c0' : '#333'};
                            line-height: 1.6;
                            font-size: 0.95rem;
                        }
                        .no-results {
                            text-align: center;
                            padding: 60px 20px;
                            color: #888;
                            animation: fadeInUp 0.5s ease;
                        }
                    </style>
                </head>
                <body>
                    <div class="search-header">
                        <h2>Search results for: "${query}"</h2>
                        <div class="result-count">${results.length} results found</div>
                    </div>
            `;

            if (results.length === 0) {
                resultsHTML += `
                    <div class="no-results">
                        <h3>No results found</h3>
                        <p>Try a different search term or check your spelling</p>
                    </div>
                `;
            } else {
                results.forEach(result => {
                    const cleanUrl = result.url.replace(/^https?:\/\//, '').split('/')[0];
                    resultsHTML += `
                        <a href="${result.url}" class="result-link">
                            <div class="result">
                                <div class="result-title">
                                    <img src="https://www.google.com/s2/favicons?domain=${cleanUrl}&sz=32" class="result-favicon" alt="" onerror="this.style.display='none'">
                                    <span>${result.title}</span>
                                </div>
                                <div class="result-url">${cleanUrl}</div>
                                <div class="result-description">${result.description}</div>
                            </div>
                        </a>
                    `;
                });
            }

            resultsHTML += `</body></html>`;

            tab.isHome = false;
            homeView.style.display = 'none';
            tab.webview.style.display = 'flex';
            tab.webview.loadURL('data:text/html;charset=utf-8,' + encodeURIComponent(resultsHTML));
            tab.tabElement.querySelector('.tab-title').textContent = `Search: ${query}`;
        }

        // Bookmarks
        function updateBookmarkIcon() {
            const tab = getActiveTab();
            if (!tab || tab.isHome || !tab.url) {
                bookmarkIcon.textContent = '‚òÜ';
                return;
            }
            const isBookmarked = bookmarks.some(b => b.url === tab.url);
            bookmarkIcon.textContent = isBookmarked ? '‚òÖ' : '‚òÜ';
        }

        function toggleBookmark() {
            const tab = getActiveTab();
            if (!tab || tab.isHome || !tab.url) return;

            const existingIndex = bookmarks.findIndex(b => b.url === tab.url);
            if (existingIndex >= 0) {
                bookmarks.splice(existingIndex, 1);
            } else {
                bookmarks.unshift({
                    url: tab.url,
                    title: tab.title || tab.url,
                    date: new Date().toISOString()
                });
            }
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            updateBookmarkIcon();
            renderBookmarks();
        }

        function renderBookmarks() {
            bookmarksList.innerHTML = bookmarks.length === 0
                ? '<div class="empty-message">No bookmarks yet</div>'
                : bookmarks.map(b => `
                    <div class="panel-item" data-url="${b.url}">
                        <img src="https://www.google.com/s2/favicons?domain=${new URL(b.url).hostname}&sz=32" class="item-favicon" alt="">
                        <div class="item-info">
                            <div class="item-title">${b.title}</div>
                            <div class="item-url">${new URL(b.url).hostname}</div>
                        </div>
                        <button class="item-delete" data-url="${b.url}">√ó</button>
                    </div>
                `).join('');

            // Click handlers
            bookmarksList.querySelectorAll('.panel-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('item-delete')) {
                        navigateToUrl(item.dataset.url);
                        bookmarksPanel.classList.remove('active');
                    }
                });
            });

            bookmarksList.querySelectorAll('.item-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const url = btn.dataset.url;
                    bookmarks = bookmarks.filter(b => b.url !== url);
                    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                    renderBookmarks();
                    updateBookmarkIcon();
                });
            });
        }

        // History
        function addToHistory(url, title) {
            if (!url || url.startsWith('data:') || url === 'about:blank') return;

            // Remove duplicate if exists
            history = history.filter(h => h.url !== url);

            // Add to front
            history.unshift({
                url: url,
                title: title || url,
                date: new Date().toISOString()
            });

            // Keep only last 100 items
            history = history.slice(0, 100);
            localStorage.setItem('history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = history.length === 0
                ? '<div class="empty-message">No history yet</div>'
                : history.slice(0, 50).map(h => `
                    <div class="panel-item" data-url="${h.url}">
                        <img src="https://www.google.com/s2/favicons?domain=${new URL(h.url).hostname}&sz=32" class="item-favicon" alt="">
                        <div class="item-info">
                            <div class="item-title">${h.title}</div>
                            <div class="item-url">${new URL(h.url).hostname}</div>
                        </div>
                    </div>
                `).join('');

            historyList.querySelectorAll('.panel-item').forEach(item => {
                item.addEventListener('click', () => {
                    navigateToUrl(item.dataset.url);
                    historyPanel.classList.remove('active');
                });
            });
        }

        function clearHistory() {
            history = [];
            localStorage.setItem('history', JSON.stringify(history));
            renderHistory();
        }

        // Theme
        function applyTheme(dark) {
            if (dark) {
                document.body.classList.add('dark-mode');
                themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.textContent = 'üåô';
            }
            localStorage.setItem('darkMode', dark);

            const tab = getActiveTab();
            if (tab && tab.isSearchResults && tab.lastSearchResults) {
                displaySearchResults(tab.lastSearchResults.query, tab.lastSearchResults.results);
            }
        }

        // Event Listeners
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                let inputValue = input.value.trim();
                if (!inputValue) return;

                if (isURL(inputValue)) {
                    let url = inputValue;
                    if (!inputValue.startsWith('http://') && !inputValue.startsWith('https://')) {
                        url = 'https://' + inputValue;
                    }
                    navigateToUrl(url);
                } else {
                    performSearch(inputValue);
                }
            }
        });

        backBtn.addEventListener('click', () => {
            const tab = getActiveTab();
            if (tab && !tab.isHome && tab.webview.canGoBack()) {
                tab.webview.goBack();
            }
        });

        forwardBtn.addEventListener('click', () => {
            const tab = getActiveTab();
            if (tab && !tab.isHome && tab.webview.canGoForward()) {
                tab.webview.goForward();
            }
        });

        refreshBtn.addEventListener('click', () => {
            const tab = getActiveTab();
            if (!tab || tab.isHome) return;

            if (tab.isSearchResults && tab.lastSearchResults) {
                performSearch(tab.lastSearchResults.query);
            } else {
                tab.webview.reload();
            }
        });

        homeBtn.addEventListener('click', showHomeForTab);
        newTabBtn.addEventListener('click', () => createTab());
        bookmarkBtn.addEventListener('click', toggleBookmark);

        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            applyTheme(isDarkMode);
        });

        // Panel toggles
        bookmarksPanelBtn.addEventListener('click', () => {
            historyPanel.classList.remove('active');
            bookmarksPanel.classList.toggle('active');
        });

        historyBtn.addEventListener('click', () => {
            bookmarksPanel.classList.remove('active');
            historyPanel.classList.toggle('active');
        });

        document.getElementById('close-bookmarks').addEventListener('click', () => bookmarksPanel.classList.remove('active'));
        document.getElementById('close-history').addEventListener('click', () => historyPanel.classList.remove('active'));
        document.getElementById('clear-history').addEventListener('click', clearHistory);

        // Card click navigation
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('click', () => {
                let tab = getActiveTab();
                
                // Navigate to the card's URL
                const url = card.dataset.url;
                const fullUrl = url.startsWith('http') ? url : 'https://' + url;
                
                tab.isHome = false;
                tab.isSearchResults = false;
                homeView.style.display = 'none';
                tab.webview.style.display = 'flex';
                tab.webview.src = fullUrl;
                
                // Update input to show URL
                input.value = fullUrl;
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key.toLowerCase()) {
                    case 't':
                        e.preventDefault();
                        createTab();
                        break;
                    case 'w':
                        e.preventDefault();
                        if (activeTabId) closeTab(activeTabId);
                        break;
                    case 'l':
                        e.preventDefault();
                        input.focus();
                        input.select();
                        break;
                    case 'tab':
                        e.preventDefault();
                        const currentIndex = tabs.findIndex(t => t.id === activeTabId);
                        const nextIndex = e.shiftKey
                            ? (currentIndex - 1 + tabs.length) % tabs.length
                            : (currentIndex + 1) % tabs.length;
                        switchToTab(tabs[nextIndex].id);
                        break;
                }
            }
            if (e.key === 'F5') {
                e.preventDefault();
                refreshBtn.click();
            }
        });

        // Close panels when clicking outside
        document.addEventListener('click', (e) => {
            if (!bookmarksPanel.contains(e.target) && !bookmarksPanelBtn.contains(e.target)) {
                bookmarksPanel.classList.remove('active');
            }
            if (!historyPanel.contains(e.target) && !historyBtn.contains(e.target)) {
                historyPanel.classList.remove('active');
            }
        });

        // Initialize
        applyTheme(isDarkMode);
        renderBookmarks();
        renderHistory();
        createTab(); // Create initial tab
    </script>
</body>

</html>