<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-AI Browser</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="browser-container">
        <header class="ui-header">
            <div class="nav-controls">
                <button class="nav-btn" id="back-btn"><span>‚Üê</span></button>
                <button class="nav-btn" id="forward-btn"><span>‚Üí</span></button>
                <button class="nav-btn" id="refresh-btn"><span>‚Üª</span></button>
                <button class="nav-btn" id="home-btn"><span>‚åÇ</span></button>
            </div>
            
            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input type="text" id="url-input" placeholder="Enter URL or Search... & No AI">
            </div>

            <div class="status-badge">
                <span class="dot"></span> AI BLOCKED
            </div>

            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                <span class="theme-icon">üåô</span>
            </button>
        </header>

        <main class="content-area">
            <div class="card-grid" id="home-view">
                <div class="card">
                    <div class="card-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                    <div class="card-content">
                        <h3>Wikipedia</h3>
                        <p>The Free Encyclopedia</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-image" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></div>
                    <div class="card-content">
                        <h3>GitHub</h3>
                        <p>Where Code Lives</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-image" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                    <div class="card-content">
                        <h3>Stack Overflow</h3>
                        <p>Developer Community</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-image" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"></div>
                    <div class="card-content">
                        <h3>MDN Web Docs</h3>
                        <p>Web Development Resources</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-image" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"></div>
                    <div class="card-content">
                        <h3>DuckDuckGo</h3>
                        <p>Privacy-Focused Search</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-image" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);"></div>
                    <div class="card-content">
                        <h3>Hacker News</h3>
                        <p>Tech News & Discussion</p>
                    </div>
                </div>
            </div>

            <webview id="wv" class="webview-content" src="about:blank" style="display: none;" 
                     partition="persist:main"
                     useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"
                     webpreferences="allowRunningInsecureContent, javascript=yes, webSecurity=yes"></webview>
        </main>
    </div>

    <script>
        const webview = document.getElementById('wv');
        const input = document.getElementById('url-input');
        const homeView = document.getElementById('home-view');
        const backBtn = document.getElementById('back-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const homeBtn = document.getElementById('home-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');

        // State variables
        let currentSearchQuery = '';
        let isShowingSearchResults = false;
        let lastSearchResults = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        function showWebview() {
            homeView.style.display = 'none';
            webview.style.display = 'flex';
        }

        function showHome() {
            homeView.style.display = 'grid';
            webview.style.display = 'none';
            input.value = '';
            isShowingSearchResults = false;
            lastSearchResults = null;
        }

        function isURL(text) {
            // If it has spaces, it's likely a search query
            if (/\s/.test(text)) return false;
            
            // If it starts with http:// or https://, it's a URL
            if (text.startsWith('http://') || text.startsWith('https://')) return true;
            
            // If it has a domain pattern (something.tld), it's likely a URL
            if (/\.\w{2,}/.test(text)) return true;
            
            // Check for localhost or IP addresses
            if (text.startsWith('localhost') || /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(text)) return true;
            
            return false;
        }

        async function performSearch(query) {
            currentSearchQuery = query;
            try {
                // Fetch DuckDuckGo HTML results
                const response = await fetch(`https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`);
                const html = await response.text();
                
                // Parse results from HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const results = [];
                const resultElements = doc.querySelectorAll('.result');
                
                resultElements.forEach(element => {
                    const titleLink = element.querySelector('.result__a');
                    const snippetEl = element.querySelector('.result__snippet');
                    const urlEl = element.querySelector('.result__url');
                    
                    if (titleLink) {
                        // Get URL - try href first, then uddg parameter, then text
                        let url = titleLink.href || '';
                        if (url.includes('uddg=')) {
                            const match = url.match(/uddg=([^&]+)/);
                            if (match) url = decodeURIComponent(match[1]);
                        }
                        if (!url && urlEl) {
                            url = urlEl.textContent.trim();
                        }
                        
                        if (url) {
                            results.push({
                                title: titleLink.textContent.trim(),
                                url: url,
                                description: snippetEl ? snippetEl.textContent.trim() : ''
                            });
                        }
                    }
                });
                
                // Always display custom results, even if empty
                displaySearchResults(query, results);
            } catch (error) {
                console.error('Search error:', error);
                // Show empty results instead of falling back to DuckDuckGo page
                displaySearchResults(query, []);
            }
        }

        function displaySearchResults(query, results) {
            // Store results for theme toggle
            lastSearchResults = { query, results };
            
            const darkMode = document.body.classList.contains('dark-mode');
            
            let resultsHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        @keyframes fadeInUp {
                            from { opacity: 0; transform: translateY(20px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        body {
                            margin: 0;
                            padding: 40px;
                            background: ${darkMode ? '#1a1a2e' : '#f2eee6'};
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
                            transition: background 0.3s ease;
                        }
                        .search-header {
                            margin-bottom: 30px;
                            animation: fadeInUp 0.5s ease;
                        }
                        .search-header h2 {
                            color: ${darkMode ? '#e0e0e0' : '#333'};
                            margin: 0 0 10px 0;
                            font-size: 1.5rem;
                            font-weight: 600;
                        }
                        .result-count {
                            color: ${darkMode ? '#888' : '#888'};
                            font-size: 0.9rem;
                        }
                        .result {
                            background: ${darkMode ? '#252542' : 'white'};
                            padding: 20px 25px;
                            margin-bottom: 15px;
                            border-radius: 12px;
                            box-shadow: ${darkMode ? '0 4px 15px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.05)'};
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            cursor: pointer;
                            border: 2px solid transparent;
                            animation: fadeInUp 0.5s ease backwards;
                        }
                        .result:nth-child(1) { animation-delay: 0.1s; }
                        .result:nth-child(2) { animation-delay: 0.15s; }
                        .result:nth-child(3) { animation-delay: 0.2s; }
                        .result:nth-child(4) { animation-delay: 0.25s; }
                        .result:nth-child(5) { animation-delay: 0.3s; }
                        .result:nth-child(6) { animation-delay: 0.35s; }
                        .result:nth-child(7) { animation-delay: 0.4s; }
                        .result:nth-child(8) { animation-delay: 0.45s; }
                        .result:hover {
                            box-shadow: ${darkMode ? '0 8px 25px rgba(143, 211, 206, 0.2)' : '0 8px 25px rgba(0,0,0,0.12)'};
                            transform: translateY(-4px) scale(1.01);
                            border-color: #8fd3ce;
                        }
                        .result:active {
                            transform: translateY(-2px) scale(1.005);
                        }
                        .result-link {
                            text-decoration: none;
                            color: inherit;
                            display: block;
                        }
                        .result-title {
                            font-size: 1.2rem;
                            color: ${darkMode ? '#8fd3ce' : '#1a73e8'};
                            font-weight: 500;
                            margin-bottom: 8px;
                            transition: color 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .result:hover .result-title {
                            color: ${darkMode ? '#a8e6cf' : '#1557b0'};
                        }
                        .result-favicon {
                            width: 20px;
                            height: 20px;
                            border-radius: 4px;
                            flex-shrink: 0;
                        }
                        .result-url {
                            color: ${darkMode ? '#6b6b8d' : '#5f6368'};
                            font-size: 0.85rem;
                            margin-bottom: 8px;
                            word-break: break-all;
                            padding-left: 30px;
                        }
                        .result-description {
                            color: ${darkMode ? '#b0b0c0' : '#333'};
                            line-height: 1.6;
                            font-size: 0.95rem;
                        }
                        .no-results {
                            text-align: center;
                            padding: 60px 20px;
                            color: #888;
                            animation: fadeInUp 0.5s ease;
                        }
                    </style>
                </head>
                <body>
                    <div class="search-header">
                        <h2>Search results for: "${query}"</h2>
                        <div class="result-count">${results.length} results found</div>
                    </div>
            `;

            if (results.length === 0) {
                resultsHTML += `
                    <div class="no-results">
                        <h3>No results found</h3>
                        <p>Try a different search term or check your spelling</p>
                    </div>
                `;
            } else {
                results.forEach(result => {
                    const cleanUrl = result.url.replace(/^https?:\/\//, '').split('/')[0];
                    resultsHTML += `
                        <a href="${result.url}" class="result-link">
                            <div class="result">
                                <div class="result-title">
                                    <img src="https://www.google.com/s2/favicons?domain=${cleanUrl}&sz=32" class="result-favicon" alt="" onerror="this.style.display='none'">
                                    <span>${result.title}</span>
                                </div>
                                <div class="result-url">${cleanUrl}</div>
                                <div class="result-description">${result.description}</div>
                            </div>
                        </a>
                    `;
                });
            }

            resultsHTML += `
                </body>
                </html>
            `;

            // Display in webview
            webview.loadURL('data:text/html;charset=utf-8,' + encodeURIComponent(resultsHTML));
            showWebview();
        }

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                let input_value = input.value.trim();
                if (!input_value) return;
                
                if (isURL(input_value)) {
                    // It's a URL - add protocol if missing
                    let url;
                    if (!input_value.startsWith('http://') && !input_value.startsWith('https://')) {
                        url = 'https://' + input_value;
                    } else {
                        url = input_value;
                    }
                    webview.src = url;
                    showWebview();
                } else {
                    // It's a search query
                    performSearch(input_value);
                }
            }
        });

        // Navigation controls
        backBtn.addEventListener('click', () => {
            // Only allow back navigation if webview is visible
            if (webview.style.display !== 'none' && webview.canGoBack()) {
                webview.goBack();
            }
        });

        forwardBtn.addEventListener('click', () => {
            // Only allow forward navigation if webview is visible
            if (webview.style.display !== 'none' && webview.canGoForward()) {
                webview.goForward();
            }
        });

        refreshBtn.addEventListener('click', () => {
            if (webview.style.display !== 'none') {
                if (isShowingSearchResults && lastSearchResults) {
                    // Refresh search results
                    performSearch(lastSearchResults.query);
                } else if (webview.src && webview.src !== 'about:blank') {
                    webview.reload();
                }
            }
        });

        homeBtn.addEventListener('click', () => {
            showHome();
        });

        // Update URL input when navigating (but not for search results page)
        webview.addEventListener('did-navigate', (e) => {
            // Ignore about:blank navigation
            if (e.url === 'about:blank') {
                return;
            }
            // If it's a data URL (our search results), keep showing the search query
            if (e.url.startsWith('data:')) {
                input.value = currentSearchQuery;
                isShowingSearchResults = true;
            } else {
                input.value = e.url;
                isShowingSearchResults = false;
            }
        });

        webview.addEventListener('did-navigate-in-page', (e) => {
            if (!e.url.startsWith('data:') && e.url !== 'about:blank') {
                input.value = e.url;
                isShowingSearchResults = false;
            }
        });

        // Handle clicks on search results - intercept navigation from data URL
        webview.addEventListener('will-navigate', (e) => {
            if (isShowingSearchResults && !e.url.startsWith('data:')) {
                // User clicked a search result, navigate to it
                e.preventDefault();
                webview.src = e.url;
                isShowingSearchResults = false;
            }
        });

        // Dark mode toggle
        function applyTheme(dark) {
            if (dark) {
                document.body.classList.add('dark-mode');
                themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.textContent = 'üåô';
            }
            localStorage.setItem('darkMode', dark);
            
            // Only regenerate search results if we're actually viewing them
            if (isShowingSearchResults && lastSearchResults && webview.style.display !== 'none') {
                displaySearchResults(lastSearchResults.query, lastSearchResults.results);
            }
        }

        // Apply saved theme on load
        applyTheme(isDarkMode);

        themeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            applyTheme(isDarkMode);
        });

        // Card click navigation
        const cards = document.querySelectorAll('.card');
        const quickLinks = [
            'https://wikipedia.org',
            'https://github.com',
            'https://stackoverflow.com',
            'https://developer.mozilla.org',
            'https://duckduckgo.com',
            'https://news.ycombinator.com'
        ];

        cards.forEach((card, index) => {
            card.addEventListener('click', () => {
                webview.src = quickLinks[index];
                input.value = quickLinks[index];
                showWebview();
            });
        });
    </script>
</body>
</html>